---
import { db, eq, Likes } from 'astro:db'
import { count } from 'drizzle-orm'
import Icon from './icon.astro'
import { cxs } from '../consts/config'
import { likeLabel } from '../utils/like-label'

export interface Props {
  slug: string
}
const { slug } = Astro.props

const [{ count: likeCount }] = await db
  .select({ count: count() })
  .from(Likes)
  .where(eq(Likes.slug, slug))

export const prerender = false
---

<like-btn data-slug={slug} data-likes={likeCount}>
  <button class={`${cxs.aIcon} group`} title={`Like this post`} type="button">
    <Icon
      type="like"
      appendClass="motion-safe:transition-transform group-hover:scale-125 group-[.cursor-not-allowed]:scale-100"
    />
    <span>{likeLabel(likeCount)}</span>
  </button>
</like-btn>
<script>
  import { likeLabel } from '../utils/like-label'

  class LikeButton extends HTMLElement {
    constructor() {
      super()
      const slug = this.dataset.slug || ''
      const initialLikes = parseInt(this.dataset.likes || '0')
      const button = this.querySelector('button')
      const svg = button?.querySelector('svg')
      const path = button?.querySelector('svg path')
      const label = button?.querySelector('span')
      button?.addEventListener('click', () => {
        button.disabled = true
        button.classList.add('cursor-not-allowed')
        if (svg && path) {
          svg.classList.add('motion-safe:animate-single-ping')
          path.setAttribute('stroke', 'oklch(60.71% 0.2743 7.34)')
        }
        if (label?.textContent) {
          label.textContent = likeLabel(initialLikes + 1)
        }
        fetch(`/api/like`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ slug }),
        })
          .then(res => res.json())
          .then(json => {
            const { count } = json
            if (count && label?.textContent) {
              label.textContent = likeLabel(count)
            }
          })
      })
    }
  }
  customElements.define('like-btn', LikeButton)
</script>

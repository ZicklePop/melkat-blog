---
import Layout from '../../../layouts/base-layout.astro'
import Article from '../../../components/article.astro'
import PageNavigator from '../../../components/page-navigator.astro'
import { byDate } from '../../../utils/sort'
import { pageSize } from '../../../consts/config'
import { noDrafts, hasType } from '../../../utils/filter'
import { getAllTypes, getPostsByType } from '../../../utils/get-posts'

export async function getStaticPaths() {
  let allPosts = await Astro.fetchContent('../../p/*.md')
  allPosts = allPosts.filter(hasType).filter(noDrafts).sort(byDate)

  const allTypes = getAllTypes(allPosts)

  return allTypes?.map(type => {
    const filtered = getPostsByType(allPosts, type)
    return {
      params: {
        type
      },
      props: {
        pages: filtered
      }
    }
  })
}

const { pages } = Astro.props
const { type } = Astro.request.params
const lastPage = Math.ceil(pages.length / pageSize)
const page = {
  lastPage,
  url: {
    next: lastPage > 1 && `/c/${type}/2`,
  },
}
---
<Layout
  title={`melkat.blog - ${type} posts${lastPage > 1 ? ', page 1 of ' + lastPage : ''}`}
  permalink={`/c/${type}`}
>
  {pages.slice(0, pageSize).map(({ title, cover, link, domain, date, url, tags, type, content }) => <Article {title} {cover} {link} {domain} {date} {url} {tags} {type}><Fragment set:html={content.html}/></Article>)}
  <PageNavigator page={page} />
</Layout>

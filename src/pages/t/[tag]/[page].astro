---
import Layout from '../../../layouts/base-layout.astro'
import PageHeader from '../../../components/page-header.astro'
import PageNavigator from '../../../components/page-navigator.astro'
import { byDate } from '../../../utils/sort'
import { pageSize, title } from '../../../consts/config'
import { getAllTags, getPostsByTag } from '../../../utils/get-posts'
import { noDrafts, hasTags } from '../../../utils/filter'

export async function getStaticPaths({ paginate }) {
  let allPosts = await Astro.glob('../../p/*.md')
  allPosts = allPosts.filter(hasTags).filter(noDrafts).sort(byDate)

  let allTags = getAllTags(allPosts)

  return allTags?.map(tag => {
    const filtered = getPostsByTag(allPosts, tag)
    return paginate(filtered, {
      params: { tag },
      pageSize,
    })
  })
}

const { page } = Astro.props
const { tag } = Astro.params
---

<Layout
  title={`${title} - posts tagged #${tag}, page ${page.currentPage} of ${page.lastPage}`}
  permalink={`/t/${tag}/${page.currentPage}`}
>
  <PageHeader>Posts tagged #{tag}</PageHeader>
  {page.data.map(({ Content }: { Content: any }) => <Content />)}
  <PageNavigator page={page} />
</Layout>

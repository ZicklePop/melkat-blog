---
import Layout from '../../layouts/base-layout.astro'
import Article from '../../components/article.astro'
import uniq from 'lodash/uniq'
import getTags from '../../utils/get-tags'
import { byDate } from '../../utils/sort'

export async function getStaticPaths() {
  let allPosts = await Astro.fetchContent('../p/*.md')
  let allTags = []
  allPosts.filter(o => !o.draft).forEach(({ tags }) => getTags(tags)?.forEach(tag => allTags.push(tag)))
  const uniqParams = uniq(allTags)?.map(tag => (
    { params: { tag } }
  ))
  return uniqParams
}

const { tag } = Astro.request.params
let posts = await Astro.fetchContent('../p/*.md');
posts = posts.filter(o => getTags(o.tags)?.includes(tag)).filter(o => !o.draft).sort(byDate);
---
<Layout title={`melkat.blog - posts tagged #${tag}`}>
  {posts.map(({ title, cover, link, domain, date, url, tags, type, content }) => <Article {title} {cover} {link} {domain} {date} {url} {tags} {type}><Fragment set:html={content.html}/></Article>)}
</Layout>
